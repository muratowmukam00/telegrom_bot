#!/bin/bash
# ============================================================================
# Очистка проекта от ненужных файлов
# ============================================================================

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}🧹 Очистка проекта от ненужных файлов...${NC}\n"

# ============================================================================
# 1. Удаляем старые/ненужные Python файлы
# ============================================================================

echo -e "${YELLOW}📁 Удаление старых Python файлов...${NC}"

# Старые файлы запуска
rm -f main.py
rm -f ws_main.py
rm -f ws_main_old.py
rm -f run_hybrid_backup3.py
rm -f test_telegram.py

echo -e "${GREEN}  ✓ Старые Python файлы удалены${NC}\n"


# ============================================================================
# 2. Удаляем старые скрипты
# ============================================================================

echo -e "${YELLOW}📁 Удаление старых скриптов...${NC}"

rm -rf scripts/
rm -f setup.sh
rm -f run_tests.sh

echo -e "${GREEN}  ✓ Старые скрипты удалены${NC}\n"


# ============================================================================
# 3. Удаляем старые модули services
# ============================================================================

echo -e "${YELLOW}📁 Удаление старых модулей...${NC}"

# Старые файлы в services/mexc/
rm -f services/mexc/monitor.py
rm -f services/mexc/ws_monitor.py
rm -f services/mexc/ws_price_manager.py

# Старые файлы в services/analysis/
rm -f services/analysis/price_buffer.py

echo -e "${GREEN}  ✓ Старые модули удалены${NC}\n"


# ============================================================================
# 4. Удаляем тестовые файлы (если не нужны тесты)
# ============================================================================

echo -e "${YELLOW}📁 Удаление тестов...${NC}"

rm -rf tests/
rm -rf .pytest_cache/
rm -f .coverage

echo -e "${GREEN}  ✓ Тесты удалены${NC}\n"


# ============================================================================
# 5. Удаляем старые графики и логи
# ============================================================================

echo -e "${YELLOW}📁 Очистка старых графиков...${NC}"

# Удаляем старые графики (оставляем директорию)
rm -f charts/*.png
rm -f logs/*.png
rm -f bot/utils/signal_chart.png
rm -rf bot/utils/logs/

echo -e "${GREEN}  ✓ Старые графики удалены${NC}\n"


# ============================================================================
# 6. Очищаем __pycache__ и .pyc файлы
# ============================================================================

echo -e "${YELLOW}📁 Очистка кэша Python...${NC}"

find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
find . -type f -name "*.pyc" -delete
find . -type f -name "*.pyo" -delete

echo -e "${GREEN}  ✓ Python кэш очищен${NC}\n"


# ============================================================================
# 7. Удаляем IDE файлы
# ============================================================================

echo -e "${YELLOW}📁 Удаление IDE файлов...${NC}"

rm -rf .idea/
rm -rf screenshots/

echo -e "${GREEN}  ✓ IDE файлы удалены${NC}\n"


# ============================================================================
# 8. Создаём .gitignore если нет
# ============================================================================

echo -e "${YELLOW}📁 Обновление .gitignore...${NC}"

cat > .gitignore << 'EOF'
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
*.egg-info/
dist/
build/

# Virtual Environment
venv/
.venv/
env/
ENV/

# Environment variables
.env

# IDE
.idea/
.vscode/
*.swp
*.swo
*~

# Logs
logs/*.log
logs/*.png
*.log

# Charts
charts/*.png

# Cache
.pytest_cache/
.coverage
*.cache

# OS
.DS_Store
Thumbs.db

# Project specific
data/.pairs_cache.txt
EOF

echo -e "${GREEN}  ✓ .gitignore обновлён${NC}\n"


# ============================================================================
# Итоги
# ============================================================================

echo -e "${GREEN}═══════════════════════════════════════════════════${NC}"
echo -e "${GREEN}✅ Очистка завершена!${NC}"
echo -e "${GREEN}═══════════════════════════════════════════════════${NC}\n"

echo "Удалено:"
echo "  • Старые Python файлы (main.py, ws_main.py, etc.)"
echo "  • Старые скрипты"
echo "  • Старые модули"
echo "  • Тесты"
echo "  • Старые графики"
echo "  • Python кэш"
echo "  • IDE файлы"
echo ""
echo "Структура проекта теперь чистая и готова для production!"
